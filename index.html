<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>MOB Guard | Man Overboard Security System</title>

<meta name="description" content="Real-time Man Overboard detection and tracking system using LoRa and GPS">
<meta name="author" content="MOB Guard">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #0f172a;
  color: #ffffff;
}

header {
  background: #020617;
  padding: 14px 20px;
  border-bottom: 1px solid #1e293b;
}

.header-row {
  display: flex;
  align-items: center;
  gap: 14px;
  flex-wrap: wrap;
}

.badge {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.live { background: #10b981; }
.offline { background: #64748b; }
.alert { background: #ef4444; }

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  padding: 16px;
}

.card {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 10px;
  padding: 14px;
}

.card-title {
  font-size: 13px;
  color: #94a3b8;
}

.card-value {
  font-size: 22px;
  font-weight: 700;
  margin-top: 6px;
}

#map {
  height: 420px;
  margin: 16px;
  border-radius: 10px;
  border: 1px solid #1e293b;
}

.alert-panel {
  position: fixed;
  right: 20px;
  bottom: 20px;
  max-width: 320px;
  background: #7f1d1d;
  border: 2px solid #ef4444;
  border-radius: 12px;
  padding: 16px;
  display: none;
  z-index: 1000;
}

.alert-panel h3 {
  margin: 0 0 8px;
}

.alert-panel button {
  width: 100%;
  padding: 10px;
  background: #ef4444;
  border: none;
  color: #fff;
  font-weight: 700;
  border-radius: 6px;
  cursor: pointer;
}
</style>
</head>

<body>

<header>
  <div class="header-row">
    <strong>MOB Guard</strong>
    <span id="connectionBadge" class="badge offline">OFFLINE</span>
    <span id="packetAge">Last packet: -- sec</span>
  </div>
</header>

<section class="dashboard">
  <div class="card">
    <div class="card-title">Device ID</div>
    <div class="card-value" id="deviceId">--</div>
  </div>

  <div class="card">
    <div class="card-title">Latitude</div>
    <div class="card-value" id="latitude">--</div>
  </div>

  <div class="card">
    <div class="card-title">Longitude</div>
    <div class="card-value" id="longitude">--</div>
  </div>

  <div class="card">
    <div class="card-title">Speed (knots)</div>
    <div class="card-value" id="speed">--</div>
  </div>

  <div class="card">
    <div class="card-title">RSSI</div>
    <div class="card-value" id="rssi">-- dBm</div>
  </div>

  <div class="card">
    <div class="card-title">Battery Voltage</div>
    <div class="card-value" id="battery">-- V</div>
  </div>
</section>

<div id="map"></div>

<div class="alert-panel" id="alertPanel">
  <h3>ðŸš¨ MAN OVERBOARD</h3>
  <div id="alertInfo"></div>
  <button onclick="acknowledgeAlert()">Acknowledge Alert</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===============================
   MAP INITIALIZATION
================================ */
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

let mobMarker = null;
let lastPacketTime = null;
let alertActive = false;

/* ===============================
   SOCKET.IO (BACKEND READY)
================================ */
let socket;
try {
  socket = io("http://localhost:3000", { transports: ["websocket"] });

  socket.on("mob_update", packet => {
    handlePacket(packet);
  });
} catch (e) {
  console.warn("WebSocket not connected (demo mode)");
}

/* ===============================
   DEMO MODE (sample JSON)
================================ */
fetch("sample-lora-payload.json")
  .then(res => res.json())
  .then(packet => handlePacket(packet));

/* ===============================
   PACKET HANDLER
================================ */
function handlePacket(p) {
  lastPacketTime = new Date(`${p.date}T${p.time}`);

  document.getElementById("deviceId").innerText = p.id;
  document.getElementById("latitude").innerText = p.latitude.toFixed(5);
  document.getElementById("longitude").innerText = p.longitude.toFixed(5);
  document.getElementById("speed").innerText = p.speed.toFixed(1);
  document.getElementById("rssi").innerText = p.rssi + " dBm";
  document.getElementById("battery").innerText = p.batteryVoltage.toFixed(2) + " V";

  updateMap(p.latitude, p.longitude);

  if (p.fallDetected && !alertActive) {
    triggerAlert(p);
  }
}

/* ===============================
   MAP UPDATE
================================ */
function updateMap(lat, lon) {
  if (!mobMarker) {
    mobMarker = L.marker([lat, lon]).addTo(map);
  } else {
    mobMarker.setLatLng([lat, lon]);
  }
  map.setView([lat, lon], 16);
}

/* ===============================
   ALERT HANDLING
================================ */
function triggerAlert(p) {
  alertActive = true;
  document.getElementById("alertPanel").style.display = "block";
  document.getElementById("alertInfo").innerHTML = `
    Device: ${p.id}<br>
    Lat: ${p.latitude.toFixed(5)}<br>
    Lon: ${p.longitude.toFixed(5)}<br>
    RSSI: ${p.rssi} dBm
  `;
  startAlarm();
}

function acknowledgeAlert() {
  document.getElementById("alertPanel").style.display = "none";
  stopAlarm();
  alertActive = false;
}

/* ===============================
   AUDIO ALARM
================================ */
let audioCtx, oscillator;

function startAlarm() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  oscillator = audioCtx.createOscillator();
  oscillator.type = "square";
  oscillator.frequency.setValueAtTime(900, audioCtx.currentTime);
  oscillator.connect(audioCtx.destination);
  oscillator.start();
}

function stopAlarm() {
  if (oscillator) oscillator.stop();
  if (audioCtx) audioCtx.close();
}

/* ===============================
   LIVE / OFFLINE STATUS
================================ */
setInterval(() => {
  if (!lastPacketTime) return;

  const diff = Math.floor((Date.now() - lastPacketTime.getTime()) / 1000);
  document.getElementById("packetAge").innerText =
    `Last packet: ${diff} sec`;

  const badge = document.getElementById("connectionBadge");
  if (diff > 10) {
    badge.innerText = "OFFLINE";
    badge.className = "badge offline";
  } else {
    badge.innerText = "LIVE";
    badge.className = "badge live";
  }
}, 1000);
</script>

</body>
</html>
